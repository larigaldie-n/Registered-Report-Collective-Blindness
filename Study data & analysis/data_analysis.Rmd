---
title: "Data analysis pilots"
author: "Nathanael Larigaldie"
date: "`r Sys.Date()`"
output: 
  pdf_document: 
    toc: yes
    latex_engine: lualatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lme4)
library(afex)
library(emmeans)
library(gridExtra)
library(sjPlot)
library(sjmisc) 
library(effects)
library(sjstats)
library(simr)
```

## Dataset loading

```{r}
datasets       <- list.files(file.path("final_data"), pattern="*.csv", full.names = TRUE)
datasets       <- lapply(datasets, read_csv, show_col_types = FALSE)

d <- datasets[[1]]
for (i in seq(from=2, to=length(datasets)))
{
  d <- rbind(d, datasets[[i]])
}
```

## Dataset preparation

```{r}
d <- d %>% mutate(Subject=rep(seq_len(length(datasets)), each=100))
```

Then we remove total dwell times <=1500ms, scale the Agreement feature and take its square, and log-transform Dwell.Time.
We do the same with Agreement.Contacts

```{r}
d_final <- d %>% filter(Dwell.Time > 1500) %>%
  mutate(Dwell.Time.Log = log(Dwell.Time),
         Agreement.Scaled = (Agreement-mean(Agreement))/sd(Agreement),
         Squared.Agreement.Scaled=Agreement.Scaled^2,
         Agreement.Contacts.Scaled = (Agreement.Contacts-mean(Agreement.Contacts))/sd(Agreement.Contacts),
         Squared.Agreement.Contacts = Agreement**2,
         Squared.Agreement.Contacts.Scaled=Agreement.Contacts.Scaled^2,
         Index=as.factor(Index), Subject=as.factor(Subject))

```

## Variables plot (violin & boxplot + density)

```{r}

violin_fixation <- ggplot(d_final, aes(x="Dwell time", y=Dwell.Time.Log)) +
  ylab("Dwell Time (log)") + theme_minimal() +
  theme(legend.position = "none") +
  geom_violin(width=1.2) + geom_boxplot(width=0.1, alpha=0.2)


violin_agreement <- ggplot(d_final, aes(x="Agreement", y=Agreement.Scaled)) +
  ylab("Agreement (scaled)") + theme_minimal() +
  theme(legend.position = "none") +
  geom_violin(width=1.2) + geom_boxplot(width=0.1, alpha=0.2)

violin_agreement_contacts <- ggplot(d_final, aes(x="Agreement (contacts)", y=Agreement.Contacts.Scaled)) +
  ylab("Agreement (constacts; scaled)") + theme_minimal() +
  theme(legend.position = "none") +
  geom_violin(width=1.2) + geom_boxplot(width=0.1, alpha=0.2)

density_fixation <- ggplot(d_final, aes(x=Dwell.Time.Log)) + geom_density()
  
density_agreement <- ggplot(d_final, aes(x=Agreement.Scaled)) + geom_density()

density_agreement_contacts <- ggplot(d_final, aes(x=Agreement.Contacts.Scaled)) + geom_density()

grid.arrange(violin_fixation, violin_agreement, violin_agreement_contacts,
             density_fixation, density_agreement, density_agreement_contacts,
             nrow=2)

```

## Statistical models


### Agreement

```{r}
res_mixed <- glmer(Dwell.Time.Log ~ Agreement.Scaled + Squared.Agreement.Scaled + Condition_Share + Agreement.Scaled*Condition_Share + Squared.Agreement.Scaled*Condition_Share +
                    (1 | Index) +
                    (Agreement.Scaled + Squared.Agreement.Scaled|Subject),
                  data=d_final, family=Gamma(link = "identity"))

summary(res_mixed)
plot_model(res_mixed,
           #axis.labels=c("Agreement (Quadratic)", "Agreement"),
           show.values=TRUE, show.p=TRUE,
           title="Quadratic effect of Agreement on total dwell times")

quad_function <- function(x, alpha, beta1, beta2, beta3, beta4, beta5, condition)
{
  return(alpha + beta1*x + beta2*x^2 + beta3*condition + beta4*(condition*x) +
           beta5*(condition*x^2))
}
```

#### Fixed effects plot

```{r}
ggplot() +
  geom_point(data=d_final, aes(Agreement.Scaled, Dwell.Time.Log)) +
  geom_function(fun=quad_function,
                args=list(alpha=summary(res_mixed)[["coefficients"]][1],
                          beta1=summary(res_mixed)[["coefficients"]][2],
                          beta2=summary(res_mixed)[["coefficients"]][3],
                          beta3=summary(res_mixed)[["coefficients"]][4],
                          beta4=summary(res_mixed)[["coefficients"]][5],
                          beta5=summary(res_mixed)[["coefficients"]][6],
                          condition = 0),
                color="blue",
                linewidth=1.5)

ggplot() +
  geom_point(data=d_final, aes(Agreement.Scaled, Dwell.Time.Log)) +
  geom_function(fun=quad_function,
                args=list(alpha=summary(res_mixed)[["coefficients"]][1],
                          beta1=summary(res_mixed)[["coefficients"]][2],
                          beta2=summary(res_mixed)[["coefficients"]][3],
                          beta3=summary(res_mixed)[["coefficients"]][4],
                          beta4=summary(res_mixed)[["coefficients"]][5],
                          beta5=summary(res_mixed)[["coefficients"]][6],
                          condition = 1),
                color="blue",
                linewidth=1.5)
```

### Agreement (contacts)

```{r}
# res_mixed <- glmer(Dwell.Time ~ Agreement.Contacts.Scaled + Squared.Agreement.Contacts.Scaled + Condition_Share + Agreement.Contacts.Scaled*Condition_Share + Squared.Agreement.Contacts.Scaled*Condition_Share +
#                     (1 | Index) +
#                     (Agreement.Contacts.Scaled + Squared.Agreement.Contacts.Scaled |Subject),
#                   data=d_final, family=inverse.gaussian(link = "identity"), control = glmerControl(optimizer ="bobyqa"))

res_mixed_gamma <- glmer(Dwell.Time ~ Agreement.Contacts.Scaled + Squared.Agreement.Contacts.Scaled + Condition_Share + Agreement.Contacts.Scaled*Condition_Share + Squared.Agreement.Contacts.Scaled*Condition_Share +
                    (1 | Index) +
                    (Agreement.Contacts.Scaled + Squared.Agreement.Contacts.Scaled |Subject),
                  data=d_final, family=Gamma(link = "identity"), control = glmerControl(optimizer ="bobyqa"))

res_mixed_log <- lmer(Dwell.Time.Log ~ Agreement.Contacts.Scaled + Squared.Agreement.Contacts.Scaled + Condition_Share + Agreement.Contacts.Scaled*Condition_Share + Squared.Agreement.Contacts.Scaled*Condition_Share +
                    (1 | Index) +
                    (Agreement.Contacts.Scaled + Squared.Agreement.Contacts.Scaled |Subject),
                  data=d_final, control = lmerControl(optimizer ="bobyqa"))

summary(res_mixed)
plot_model(res_mixed,
           #axis.labels=c("Agreement (Quadratic)", "Agreement"),
           show.values=TRUE, show.p=TRUE,
           title="Quadratic effect of contacts Agreement on total dwell times")


```

#### Fixed effects plot

```{r}
ggplot() +
  geom_point(data=d_final, aes(Agreement.Contacts.Scaled, Dwell.Time)) +
  geom_function(fun=quad_function,
                args=list(alpha=summary(res_mixed)[["coefficients"]][1],
                          beta1=summary(res_mixed)[["coefficients"]][2],
                          beta2=summary(res_mixed)[["coefficients"]][3],
                          beta3=summary(res_mixed)[["coefficients"]][4],
                          beta4=summary(res_mixed)[["coefficients"]][5],
                          beta5=summary(res_mixed)[["coefficients"]][6],
                          condition = 0),
                color="blue",
                linewidth=1.5)

ggplot() +
  geom_point(data=d_final, aes(Agreement.Contacts.Scaled, Dwell.Time)) +
  geom_function(fun=quad_function,
                args=list(alpha=summary(res_mixed)[["coefficients"]][1],
                          beta1=summary(res_mixed)[["coefficients"]][2],
                          beta2=summary(res_mixed)[["coefficients"]][3],
                          beta3=summary(res_mixed)[["coefficients"]][4],
                          beta4=summary(res_mixed)[["coefficients"]][5],
                          beta5=summary(res_mixed)[["coefficients"]][6],
                          condition = 1),
                color="blue",
                linewidth=1.5)

```

### Residuals analysis

```{r}
qqnorm(residuals(res_mixed))
qqline(residuals(res_mixed))
hist(residuals(res_mixed))
ks.test(x=residuals(res_mixed), y='pnorm')
```

